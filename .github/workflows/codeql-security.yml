name: CodeQL PRs
on:
  schedule:
    - cron: '00 00 * * 1'
  # Allow manual UI trigger
  workflow_dispatch:
permissions:
  contents: write
  issues: write
  pull-requests: write
  security-events: read
jobs:
  autofix:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_REPO: ${{ github.repository }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install jq
        run: sudo apt-get install jq
      - name: Get open CodeQL alerts
        id: alerts
        run: |
          # Opened Query Alerts (tool=CodeQL, state=open)
          ALERTS=$(gh api /repos/$GITHUB_REPO/code-scanning/alerts --jq '.alerts[] | select(.tool.name=="CodeQL") | @base64')
          echo "alerts_count=$(echo $ALERTS | jq length)" >> $GITHUB_OUTPUT
          echo "alerts_data<<EOF" >> $GITHUB_OUTPUT
          echo $ALERTS >> $GITHUB_OUTPUT
          echo EOF >> $GITHUB_OUTPUT
      - name: Generate and apply fixes
        if: steps.alerts.outputs.alerts_count > 0
        env:
          USER: ${{ github.repository_owner }}
        run: |
          ALERTS=$(cat <<EOF
          ${{ steps.alerts.outputs.alerts_data }}
          EOF
          )
          for ALERT in $(echo $ALERTS | jq -r '.[] | @base64'); do
            ALERT_ID=$(echo $ALERT | base64 -d | jq -r '.id')
            echo "Processing alert $ALERT_ID"

            # Step 1: Generate fix via Autofix API (POST /code-scanning/alerts/{alert_id}/autofixes)
            FIX_RESPONSE=$(gh api -X POST /repos/$GITHUB_REPO/code-scanning/alerts/$ALERT_ID/autofixes)
            FIX_ID=$(echo $FIX_RESPONSE | jq -r '.id')

            if [ "$FIX_ID" = "null" ]; then
              echo "No fix generated for $ALERT_ID"
              continue
            fi
            # Step 2: Commit fix to dedicated branch
            BRANCH_NAME="autofix-codeql-$ALERT_ID"

            gh api -X POST /repos/$GITHUB_REPO/git/refs -f ref="refs/heads/$BRANCH_NAME" -F sha="$(git rev-parse HEAD)"

            # Apply fix
            COMMIT_RESPONSE=$(gh api -X POST /repos/$GITHUB_REPO/code-scanning/alerts/$ALERT_ID/autofixes/$FIX_ID/commit \
              -F branch="$BRANCH_NAME" \
              -F commit_message="Auto-fix for CodeQL alert $ALERT_ID")

            echo "Committed fix to $BRANCH_NAME"

            # Step 3: Create draft PR

            PR_TITLE="Auto-fix: CodeQL alert #$ALERT_ID"
            PR_BODY="Generated by Copilot Autofix. Review and test before merge."
            PR_RESPONSE=$(gh pr create --title "$PR_TITLE" --body "$PR_BODY" --head "$BRANCH_NAME" --base "main" --draft)
            PR_NUMBER=$(echo $PR_RESPONSE | jq -r '.number')

            # Step 4: Assign to owner
            gh pr edit $PR_NUMBER --add-assignee $USER
            # Close fixed alert
            gh api -X PATCH /repos/$GITHUB_REPO/code-scanning/alerts/$ALERT_ID -f state="fixed"
          done
